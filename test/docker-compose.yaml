---

x-app: &centurion
  image: ${CENTURION_IMAGE:-ghcr.io/nofusscomputing/centurion-erp}:${CENTURION_IMAGE_TAG:-dev}
  volumes:
    - ./docker/settings.py:/etc/itsm/settings.py:ro


services:


  postgres:
    image: ${CENTURION_POSTGRES_IMAGE:-postgres}:${CENTURION_POSTGRES_IMAGE_TAG:-13.21}-alpine    # 14.18-alpine, 15.13-alpine, 16.9-alpine, 17.5-alpine
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    ports:
      - 5432:5432
    volumes:
      - ./docker/centurion.sql:/docker-entrypoint-initdb.d/centurion.sql:ro


  rabbitmq:
    image: ${CENTURION_RABBITMQ_IMAGE:-rabbitmq}:${CENTURION_RABBITMQ_IMAGE_TAG:-4.0.9}-management-alpine    # 4.1.3-management-alpine
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
      - RABBITMQ_DEFAULT_VHOST=itsm
    ports:
      - "5672:5672"
      - "15672:15672"


  centurion-init:
    <<: *centurion
    container_name: centurion-erp-init
    restart: "no"
    entrypoint: ""
    command: sh -c 'sleep 15; python manage.py migrate'
    depends_on:
      - postgres
      - rabbitmq


  centurion:
    <<: *centurion
    container_name: centurion-erp
    restart: always
    hostname: centurion-erp
    volumes:
      - ./volumes/log:/var/log:rw
      - ./docker/settings.py:/etc/itsm/settings.py:ro
      - ./volumes/data:/data:rw
      - ./volumes/artifacts:/app/artifacts:rw
    ports:
      - "8003:8000"
    depends_on:
      - postgres
      - rabbitmq


  worker:
    <<: *centurion
    container_name: centurion-worker
    restart: always
    environment:
      - IS_WORKER=true
    hostname: centurion-worker
    depends_on:
      - postgres
      - rabbitmq
      - centurion

  centurion-ui:
    image: ${CENTURION_UI_IMAGE:-ghcr.io/nofusscomputing/centurion-erp-ui}:${CENTURION_UI_IMAGE_TAG:-dev}
    container_name: centurion-ui
    restart: always
    environment:
      - API_URL=http://127.0.0.1:8003/api/v2
    hostname: centurion-ui
    ports:
      - "3000:80"
    depends_on:
      - centurion
